<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¦–è´è€… | WebRTC Viewer</title>
<style>
  body {
    background: #111;
    color: #eee;
    text-align: center;
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
  }
  #remote {
    width: 90%;
    max-width: 800px;
    border-radius: 12px;
    background: #000;
    margin: 20px auto;
  }
  button {
    padding: 12px 30px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #2196F3;
    color: white;
    cursor: pointer;
    margin: 10px;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #0b7dda;
  }
  #status {
    margin: 20px;
    padding: 10px;
    border-radius: 8px;
    display: inline-block;
  }
  .status-disconnected { background: #666; }
  .status-connecting { background: #FF9800; }
  .status-connected { background: #4CAF50; }
  .status-error { background: #f44336; }
  .status-waiting { background: #9C27B0; }
  .debug-info {
    margin-top: 20px;
    padding: 10px;
    background: #222;
    border-radius: 8px;
    font-size: 12px;
    text-align: left;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
</head>
<body>
<h1>ğŸ“± è¦–è´ãƒšãƒ¼ã‚¸</h1>

<div id="status" class="status-disconnected">æœªæ¥ç¶š</div>

<video id="remote" autoplay playsinline></video>

<div>
  <button id="connectBtn">æ¥ç¶šã—ã¦è¦–è´</button>
</div>

<div class="debug-info">
  <div><strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong></div>
  <div id="debugLog"></div>
</div>

<script>
const WS_URL = "wss://k-divenohtml.onrender.com";

const ICE_SERVERS = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'stun:stun2.l.google.com:19302' },
  {
    urls: 'turn:openrelay.metered.ca:80',
    username: 'openrelayproject',
    credential: 'openrelayproject'
  },
  {
    urls: 'turn:openrelay.metered.ca:443',
    username: 'openrelayproject',
    credential: 'openrelayproject'
  }
];

let ws = null;
let pc = null;
let reconnectInterval = null;
let myViewerId = null;

const statusDiv = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const video = document.getElementById('remote');
const debugLog = document.getElementById('debugLog');

function log(msg) {
  console.log(msg);
  const time = new Date().toLocaleTimeString();
  debugLog.innerHTML = `[${time}] ${msg}<br>` + debugLog.innerHTML;
  const lines = debugLog.innerHTML.split('<br>');
  if (lines.length > 30) {
    debugLog.innerHTML = lines.slice(0, 30).join('<br>');
  }
}

function updateStatus(text, className) {
  statusDiv.textContent = text;
  statusDiv.className = className;
}

function connectWebSocket() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  
  updateStatus('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...', 'status-connecting');
  log('ğŸ”„ WebSocketæ¥ç¶šã‚’è©¦è¡Œä¸­...');
  ws = new WebSocket(WS_URL);
  
  ws.onopen = () => {
    log('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
    updateStatus('é…ä¿¡å¾…æ©Ÿä¸­...', 'status-waiting');
    
    if (reconnectInterval) {
      clearInterval(reconnectInterval);
      reconnectInterval = null;
    }
    
    // è¦–è´è€…ã¨ã—ã¦ç™»éŒ²
    log('ğŸ“¤ è¦–è´è€…ã¨ã—ã¦ç™»éŒ²');
    ws.send(JSON.stringify({ viewer: true }));
  };
  
  ws.onmessage = async (e) => {
    try {
      const msg = JSON.parse(e.data);
      
      // ç™»éŒ²å®Œäº†
      if (msg.type === 'registered' && msg.role === 'viewer') {
        myViewerId = msg.viewerId;
        log(`âœ… è¦–è´è€…IDã‚’å–å¾—: ${myViewerId}`);
      }
      
      // é…ä¿¡çµ‚äº†
      else if (msg.type === 'broadcasterDisconnected') {
        log('ğŸ›‘ é…ä¿¡ãŒçµ‚äº†ã—ã¾ã—ãŸ');
        updateStatus('é…ä¿¡ãŒçµ‚äº†ã—ã¾ã—ãŸ', 'status-error');
        if (pc) {
          pc.close();
          pc = null;
        }
        video.srcObject = null;
        connectBtn.disabled = false;
      }
      
      // é…ä¿¡è€…ã‹ã‚‰ã®Offer
      else if (msg.type === 'offer') {
        log('ğŸ“¥ é…ä¿¡è€…ã‹ã‚‰Offerã‚’å—ä¿¡');
        updateStatus('é…ä¿¡ã«æ¥ç¶šä¸­...', 'status-connecting');
        
        // PeerConnectionä½œæˆ
        if (pc) pc.close();
        pc = new RTCPeerConnection({ 
          iceServers: ICE_SERVERS,
          iceCandidatePoolSize: 10,
          bundlePolicy: 'max-bundle',
          rtcpMuxPolicy: 'require'
        });
        log('ğŸ”— PeerConnectionä½œæˆ');
        
        // ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡
        pc.ontrack = (e) => {
          log('ğŸ“º æ˜ åƒãƒˆãƒ©ãƒƒã‚¯ã‚’å—ä¿¡');
          log(`ğŸ“º ãƒˆãƒ©ãƒƒã‚¯æƒ…å ±: kind=${e.track.kind}, enabled=${e.track.enabled}, readyState=${e.track.readyState}`);
          
          if (video.srcObject !== e.streams[0]) {
            video.srcObject = e.streams[0];
            log('âœ… ãƒ“ãƒ‡ã‚ªã‚½ãƒ¼ã‚¹è¨­å®šå®Œäº†');
          }
          
          updateStatus('âœ… è¦–è´ä¸­', 'status-connected');
        };
        
        // ICEå€™è£œã®å‡¦ç†
        pc.onicecandidate = (e) => {
          if (e.candidate && ws && ws.readyState === WebSocket.OPEN) {
            log('ğŸ§Š ICEå€™è£œã‚’é…ä¿¡è€…ã«é€ä¿¡');
            ws.send(JSON.stringify({ 
              candidate: e.candidate,
              viewerId: myViewerId
            }));
          } else if (!e.candidate) {
            log('âœ… ICEå€™è£œã®åé›†å®Œäº†');
          }
        };
        
        pc.oniceconnectionstatechange = () => {
          const state = pc.iceConnectionState;
          log(`ğŸ”„ ICEæ¥ç¶šçŠ¶æ…‹: ${state}`);
          
          if (state === 'connected' || state === 'completed') {
            updateStatus('âœ… è¦–è´ä¸­', 'status-connected');
          } else if (state === 'disconnected') {
            log('âš ï¸ ä¸€æ™‚çš„ã«åˆ‡æ–­');
            updateStatus('æ¥ç¶šãŒä¸å®‰å®šã§ã™', 'status-error');
          } else if (state === 'failed') {
            log('âŒ ICEæ¥ç¶šå¤±æ•—');
            updateStatus('æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ', 'status-error');
            video.srcObject = null;
          }
        };
        
        pc.onconnectionstatechange = () => {
          log(`ğŸ”„ PeerConnectionçŠ¶æ…‹: ${pc.connectionState}`);
        };
        
        // Offerè¨­å®šã¨Answerä½œæˆ
        log('ğŸ“ RemoteDescriptionã‚’è¨­å®š');
        await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
        
        log('ğŸ“ Answerä½œæˆä¸­...');
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        log('âœ… LocalDescriptionè¨­å®šå®Œäº†');
        
        // Answerã‚’é€ä¿¡
        if (ws && ws.readyState === WebSocket.OPEN && myViewerId) {
          log('ğŸ“¤ Answerã‚’é…ä¿¡è€…ã«é€ä¿¡');
          ws.send(JSON.stringify({ 
            answer,
            viewerId: myViewerId
          }));
        }
        
        connectBtn.disabled = true;
      }
      
      // é…ä¿¡è€…ã‹ã‚‰ã®ICEå€™è£œ
      else if (msg.type === 'candidate' && pc) {
        log('ğŸ§Š é…ä¿¡è€…ã‹ã‚‰ICEå€™è£œã‚’å—ä¿¡');
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
      
    } catch (err) {
      log('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + err.message);
      updateStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message, 'status-error');
    }
  };
  
  ws.onerror = (err) => {
    log('âŒ WebSocketã‚¨ãƒ©ãƒ¼');
    updateStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'status-error');
  };
  
  ws.onclose = () => {
    log('ğŸ”Œ WebSocketåˆ‡æ–­');
    updateStatus('åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'status-disconnected');
    connectBtn.disabled = false;
    
    if (!reconnectInterval) {
      reconnectInterval = setInterval(() => {
        log('ğŸ”„ è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œ...');
        connectWebSocket();
      }, 3000);
    }
  };
}

connectBtn.onclick = () => {
  connectWebSocket();
};

window.addEventListener('beforeunload', () => {
  if (pc) pc.close();
  if (ws) ws.close();
});

// è‡ªå‹•æ¥ç¶šã¯ã—ãªã„
log('ğŸš€ è¦–è´è€…ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
</script>
</body>
</html>
