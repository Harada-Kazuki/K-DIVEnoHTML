ws.onmessage = async (e) => {
  try {
    const msg = JSON.parse(e.data);

    if (msg.broadcasterDisconnected) {
      updateStatus("é…ä¿¡ãŒçµ‚äº†ã—ã¾ã—ãŸ", "status-error");
      if (pc) {
        pc.close();
        pc = null;
      }
      video.srcObject = null;
      connectBtn.disabled = false;
      return;
    }

    // ğŸ‘€ Offerã‚’å—ä¿¡ã—ãŸã¨ã
    if (msg.offer) {
      console.log("ğŸ“¡ Offer received from broadcaster");

      // å¤ã„PeerConnectionãŒæ®‹ã£ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
      if (pc) {
        try {
          pc.close();
        } catch {}
        pc = null;
      }

      // PeerConnectionã‚’æ–°è¦ä½œæˆ
      pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

      // æ˜ åƒãƒˆãƒ©ãƒƒã‚¯å—ä¿¡
      pc.ontrack = (e) => {
        console.log("ğŸ Remote track received");
        video.srcObject = e.streams[0];
        video.play().catch((err) => {
          console.warn("âš ï¸ Autoplay blocked:", err);
        });
        updateStatus("âœ… è¦–è´ä¸­", "status-connected");
      };

      // ICEå€™è£œé€ä¿¡
      pc.onicecandidate = (e) => {
        if (e.candidate && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ candidate: e.candidate }));
        }
      };

      // çŠ¶æ…‹ç›£è¦–
      pc.oniceconnectionstatechange = () => {
        console.log("ICE state:", pc.iceConnectionState);
        if (pc.iceConnectionState === "disconnected" || pc.iceConnectionState === "failed") {
          updateStatus("æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ", "status-error");
          video.srcObject = null;
        }
      };

      // Offerè¨­å®š â†’ Answerä½œæˆ
      await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // Answerã‚’ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
      ws.send(JSON.stringify({ answer }));
      connectBtn.disabled = true;
      return;
    }

    // ğŸ§Š ICE candidateã‚’å—ä¿¡ã—ãŸã¨ã
    if (msg.candidate && pc) {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      } catch (err) {
        console.error("âŒ Failed to add ICE candidate:", err);
      }
      return;
    }

    // ğŸ’¤ é…ä¿¡å¾…æ©Ÿ
    if (msg.waiting) {
      updateStatus("é…ä¿¡å¾…æ©Ÿä¸­...", "status-waiting");
      connectBtn.disabled = false;
    }

  } catch (err) {
    console.error("âŒ Error handling message:", err);
    updateStatus("ã‚¨ãƒ©ãƒ¼: " + err.message, "status-error");
  }
};
